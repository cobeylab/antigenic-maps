---
title: "Use stan to re-fit antigenic maps for Smith 2004 and Bedford et al. 2014"
output: html_notebook
---


```{r setup, include=FALSE}
rm(list = ls())
library(tidyr)
library(dplyr)
filter <- dplyr::filter
extract <- tidyr::extract
select <- dplyr::select
summarise <- dplyr::summarise
source('../R/utility-functions.R')
source('../R/reanalyze-data.R')
source('../R/stan_funs_sparse_data.R')
```

## Load the data

As described in `Check_data.Rmd`:

* Smith_data is the subset of the observations in the Bedford et al. 2014 supplement from the Smith 2004 study. Smith et al. 2004 did not publish their data directly, but about 85% of their observations are available in the Bedford et al. supplement.
* Bedford_data is all data from the Bedford et al. 2014 supplement, which includes data from many studies including Smith et al. 2004.


```{r}
Bedford_data <- read_delim('Bedford_2014_data.txt') %>% 
  mutate(num_titer = parse_numeric_titers(titer),
         logtiter = log2(num_titer)) %>%
  group_by(virusStrain, serumStrain, source) %>%
  dplyr::mutate(replicate = 1:n()) %>%
  mutate(antigen = as.factor(paste0(source, '_', virusStrain, '_', replicate)),
         serum = as.factor(paste0(source, '_', serumStrain, '_', replicate))) %>%
  ungroup()
```


```{r}
head(Bedford_data)
```

```{r}
head(Smith_data)
```







```{r}
Smith_data <- read_csv('Smith_2004_subset_of_Bedford_2014.csv') %>% select(virusStrain, virusYear, serumStrain, serumYear, source, titer) %>%
  mutate(num_titer = parse_numeric_titers(titer),
         logtiter = log2(num_titer)) %>%
  group_by(virusStrain, serumStrain, source) %>%
  dplyr::mutate(replicate = 1:n()) %>%
  mutate(antigen = as.factor(paste0(source, '_', virusStrain)),
         serum = as.factor(paste0(source, '_', serumStrain, '_', replicate))) %>%
  ungroup()
```


```{r}
head(Smith_data)
```

## Get logtiter matrix
```{r}
smith_logtiter_matrix <- Smith_data %>%
  select(serum, antigen, logtiter) %>%
  complete(serum, antigen) %>%
  pivot_wider(values_from = logtiter, names_from = antigen) 
write_csv(x = smith_logtiter_matrix, file = 'Smith_logtiter_matrix.csv')
serum_names = smith_logtiter_matrix %>% pull(serum)
smith_logtiter_matrix <- smith_logtiter_matrix[,-1] %>% as.matrix()
rownames(smith_logtiter_matrix) = serum_names
```

```{r}
library(irlba)
irlba(A = smith_logtiter_matrix)
```





# 1. Smith reanalysis

## 1.1 - Get the distance matrix from the titer panel

```{r}
Smith_test_train = test_train_split(Smith_data)
fit_stan_MDS(mod = '../stan/MDS_predict_titer_sparse.stan', titer_map_train = )
```

