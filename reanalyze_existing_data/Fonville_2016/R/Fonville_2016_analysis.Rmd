---
title: "Fonville 2016 reanalysis"
output: html_notebook
---
```{r include=FALSE}
rm(list = ls())
library(ggplot2)
library(tidyr)
library(dplyr)
filter <- dplyr::filter
source('analysis_funs.R')
```

## Import ferret titer data

## Sera and strain panels differ. Ugs. ID homologous pairs tomorrow.

```{r}
ferret_titers = import_ferret_titers()
```

## Import ferret distances

```{r}
ferret_distances = import_map_distances()
```


## Import human titer data
```{r}
child_titers = import_human_titer_data()
```

## Identify homologous strains

```{r}
individual_distances <- import_human_titer_data() %>%
  group_by(subject, season, age_mos) %>%
  extract(season, into = 'season_y1', regex = '(\\d\\d\\d\\d)/\\d+', convert = T, remove = F) %>% # Extract first year of season in which sample was collected
  mutate(earliest_possible_YOB = season_y1 - ceiling(age_mos/12),
         latest_possible_YO_sample = season_y1 + 2,
         circulated_in_infection_window = strain_year >= earliest_possible_YOB & strain_year <= latest_possible_YO_sample,
         max_titer_strain = ifelse(titer == max(titer), strain, NA),
         putative_primary_strain = ifelse(strain %in% get_putative_primary_strains(strain, titer, circulated_in_infection_window), as.character(strain), NA),
         subject_label = get_subject_factor_by_YOB(subject, earliest_possible_YOB, season),
         xval = jitter(strain_year),
         homologous_titer = max(logtiter[circulated_in_infection_window]),
         individual_distance = homologous_titer - logtiter) %>%
  ungroup()
```

```{r}
individual_distances %>%
   mutate(undetectable_titers = ifelse(logtiter<0, logtiter, NA)) %>%
   mutate(ribbon_vals = ifelse(circulated_in_infection_window, strain_year, NA)) %>%
  ggplot() +
#  geom_vline(aes(xintercept = earliest_possible_YOB), color = 'dodgerblue')+
#  geom_vline(aes(xintercept = latest_possible_YO_sample), color = 'dodgerblue')+
  facet_wrap(.~subject_label, ncol = 4) +
  geom_ribbon(aes(x = ribbon_vals, ymin = -1, ymax = 15), fill = 'aquamarine', alpha = .5) +
  geom_point(aes(x = xval, y = logtiter, color = circulated_in_infection_window)) +
  geom_point(aes(x = xval, y = undetectable_titers), color = 'gray') +
  geom_point(aes(x = xval, y = logtiter), pch = 4, data = individual_distances %>% filter(!is.na(putative_primary_strain))) +
  geom_vline(aes(xintercept = xval), lty = 2, color = 'springgreen4', data = individual_distances %>% filter(!is.na(putative_primary_strain))) +
  geom_text(aes(x = xval+3, y = logtiter+4, label = strain), angle = 50, data = individual_distances %>% filter(!is.na(putative_primary_strain)), size = 2.5) +
  theme(legend.position = c(.75, 0.05)) +
  xlab('Year of strain isolation') +
 # ylim(c(0, 12))+
  theme(axis.text.x = element_text(angle = 35, hjust = 1))
ggsave('../plots/subject_titers.png', width = 9, height = 7, units = 'in', dpi = 300)
```

## Replot without annotation for build
```{r}
individual_distances %>%
   mutate(undetectable_titers = ifelse(logtiter<0, logtiter, NA)) %>%
   mutate(ribbon_vals = ifelse(circulated_in_infection_window, strain_year, NA)) %>%
  ggplot() +
#  geom_vline(aes(xintercept = earliest_possible_YOB), color = 'dodgerblue')+
#  geom_vline(aes(xintercept = latest_possible_YO_sample), color = 'dodgerblue')+
  facet_wrap(.~subject_label, ncol = 4) +
  geom_ribbon(aes(x = ribbon_vals, ymin = -1, ymax = 15), fill = 'aquamarine', alpha = .5) +
  geom_point(aes(x = xval, y = logtiter, color = circulated_in_infection_window)) +
  geom_point(aes(x = xval, y = undetectable_titers), color = 'gray') +
  geom_point(aes(x = xval, y = logtiter), pch = 4, data = individual_distances %>% filter(!is.na(putative_primary_strain))) +
 # geom_vline(aes(xintercept = xval), lty = 2, color = 'springgreen4', data = individual_distances %>% filter(!is.na(putative_primary_strain))) +
  #geom_text(aes(x = xval+3, y = logtiter+4, label = strain), angle = 50, data = individual_distances %>% filter(!is.na(putative_primary_strain)), size = 2.5) +
  theme(legend.position = c(.75, 0.05)) +
  xlab('Year of strain isolation') +
 # ylim(c(0, 12))+
  theme(axis.text.x = element_text(angle = 35, hjust = 1))
ggsave('../plots/subject_titers_build.png', width = 9, height = 7, units = 'in', dpi = 300)
```






Figure legend: Each subject's logtiter to all strains in the panel. The blue lines demarcate the infection window - the left line is the earliest possible year of birth, and the right line is the latest possible calendar year of sampling, based on the reported sample season, and the subject's age in months at the time of sampling. Putative primary strains, defined as the strain(s) in the infection window to which the subject shows the highest logtiter, are marked with a black x and named.

Observations:

* In many, but not all subjects, the highest titer is to a strain in the infection window.
* In some subjects, there are two putative homologous strains. 


## Which strains should be considered homologous?

I propose this definition:

1. Individual distance = $s_{max}-s_j$, where $s_max$ is the maximum log titer to any strain that circulated in the sampling window, and $s_j$ is the logtiter to the test strain



## Compare individual to ferret distances
```{r}
# To calculate individual distances:
#   
# 1. ID each possible primary strain
# 2. For each possible primary strain, extract pairwise distanes
# 3. Merge the pairwise distances

merged_distances = individual_distances %>%
  group_by(subject, putative_primary_strain) %>%
   mutate(homologous_titer = unique(logtiter[strain == putative_primary_strain])) %>%
  filter(!is.na(putative_primary_strain)) %>%
  select(subject, putative_primary_strain, homologous_titer) %>%
  distinct() %>%
  ungroup() %>% ## Get a df of subjects and primary starins
merge(  ## Merge with the ferret distances from each primary strain to all other strains
  ferret_distances %>%
    rename(putative_primary_strain = strain1,
           strain = strain2,
           ferret_map_distance = distance),
  all.y = T
) %>%
  merge(individual_distances %>% select(-putative_primary_strain)) %>%
  mutate(strain = factor(strain, levels = get_strains_chronologically(strain, strain_year))) %>%
  ungroup() %>% group_by(subject) %>%
  mutate(primary_strain_id = as.numeric(factor(putative_primary_strain)),
         x_dodge = as.numeric(strain) + (primary_strain_id-mean(primary_strain_id))*.2) %>%
  ungroup() %>%
  mutate(primary_strain_year = extract_strain_year(putative_primary_strain),
         ferret_overestimate = ferret_map_distance - individual_distance,
         temporal_distance = abs(strain_year - primary_strain_year),
         dy = strain_year - primary_strain_year,
         temporal_distance = abs(dy),
         `past/future` = ifelse(dy<0, 'past', 'future')) %>%
  merge(read_csv('../processed_data/subject_primary_sample_timing.csv'))
```



```{r}
merged_distances %>%
  filter(is_high_responder) %>%
  mutate(ribbon_vals = ifelse(circulated_in_infection_window, as.numeric(strain), NA),
         adjusted_ferret_distance = adjust_ferret_distances(ferret_map_distance, `past/future`),
         expected_logtiter_ferret_distance = homologous_titer - ferret_map_distance,
         expected_logtiter_adjusted_distance = homologous_titer - adjusted_ferret_distance,
         is_undetectable = ifelse(logtiter<0, logtiter, NA)) %>%
  ggplot() +
  geom_point(aes(x = strain, y = logtiter), color = NA) +
  geom_ribbon(aes(x = x_dodge, ymin = -10, ymax = 0), fill = 'gray', alpha = .5) +
  geom_ribbon(aes(x = ribbon_vals, ymin = -10, ymax = 8), fill = 'aquamarine', alpha = .5) +
  geom_hline(aes(yintercept = 0), lty = 3)+
  geom_hline(aes(yintercept = homologous_titer), lty = 2)+
  geom_vline(aes(xintercept = putative_primary_strain), lty = 3)+
  geom_segment(aes(x = x_dodge, xend = x_dodge, y = logtiter, yend = expected_logtiter_ferret_distance), color = 'firebrick2', lty = 2) +
  geom_segment(aes(x = x_dodge, xend = x_dodge, y = homologous_titer, yend = logtiter, lty = logtiter<0), show.legend = F) +
  geom_point(aes(x = x_dodge, y = logtiter)) +
  geom_point(aes(x = x_dodge, y = is_undetectable), pch = 23, fill = 'gray') +
  geom_segment(aes(x = x_dodge-.2, xend = x_dodge+.2, y = expected_logtiter_ferret_distance, yend = expected_logtiter_ferret_distance), color = 'firebrick2') +
 # geom_segment(aes(x = x_dodge-.2, xend = x_dodge+.2, y = expected_logtiter_adjusted_distance, yend = expected_logtiter_adjusted_distance), color = 'deepskyblue') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(.~subject_label) +
  ylab('distance from primary strain') +
  ggtitle('High responders')
ggsave('../plots/high_responder_comparison.png', width = 9, height = 6, dpi = 300, units = 'in')
```

```{r}
merged_distances %>%
  filter(is_high_responder) %>%
  mutate(ribbon_vals = ifelse(circulated_in_infection_window, as.numeric(strain), NA),
         adjusted_ferret_distance = adjust_ferret_distances(ferret_map_distance, `past/future`),
         expected_logtiter_ferret_distance = homologous_titer - ferret_map_distance,
         expected_logtiter_adjusted_distance = homologous_titer - adjusted_ferret_distance,
         is_undetectable = ifelse(logtiter<0, logtiter, NA)) %>%
  ggplot() +
  geom_point(aes(x = strain, y = logtiter), color = NA) +
  geom_ribbon(aes(x = x_dodge, ymin = -10, ymax = 0), fill = 'gray', alpha = .5) +
  geom_ribbon(aes(x = ribbon_vals, ymin = -10, ymax = 8), fill = 'aquamarine', alpha = .5) +
  geom_hline(aes(yintercept = 0), lty = 3)+
  #geom_hline(aes(yintercept = homologous_titer), lty = 2)+
  geom_vline(aes(xintercept = putative_primary_strain), lty = 3)+
  #geom_segment(aes(x = x_dodge, xend = x_dodge, y = logtiter, yend = expected_logtiter_ferret_distance), color = 'firebrick2', lty = 2) +
  #geom_segment(aes(x = x_dodge, xend = x_dodge, y = homologous_titer, yend = logtiter, lty = logtiter<0), show.legend = F) +
  geom_point(aes(x = x_dodge, y = logtiter)) +
  geom_point(aes(x = x_dodge, y = is_undetectable), pch = 23, fill = 'gray') +
  #geom_segment(aes(x = x_dodge-.2, xend = x_dodge+.2, y = expected_logtiter_ferret_distance, yend = expected_logtiter_ferret_distance), color = 'firebrick2') +
 # geom_segment(aes(x = x_dodge-.2, xend = x_dodge+.2, y = expected_logtiter_adjusted_distance, yend = expected_logtiter_adjusted_distance), color = 'deepskyblue') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(.~subject_label) +
  ylab('distance from primary strain') +
  ggtitle('High responders')
ggsave('../plots/high_responder_comparison_build0.png', width = 9, height = 6, dpi = 300, units = 'in')
```



```{r}
merged_distances %>%
  filter(is_high_responder) %>%
  mutate(ribbon_vals = ifelse(circulated_in_infection_window, as.numeric(strain), NA),
         adjusted_ferret_distance = adjust_ferret_distances(ferret_map_distance, `past/future`),
         expected_logtiter_ferret_distance = homologous_titer - ferret_map_distance,
         expected_logtiter_adjusted_distance = homologous_titer - adjusted_ferret_distance,
         is_undetectable = ifelse(logtiter<0, logtiter, NA)) %>%
  ggplot() +
  geom_point(aes(x = strain, y = logtiter), color = NA) +
  geom_ribbon(aes(x = x_dodge, ymin = -10, ymax = 0), fill = 'gray', alpha = .5) +
  geom_ribbon(aes(x = ribbon_vals, ymin = -10, ymax = 8), fill = 'aquamarine', alpha = .5) +
  geom_hline(aes(yintercept = 0), lty = 3)+
  geom_hline(aes(yintercept = homologous_titer), lty = 2)+
  geom_vline(aes(xintercept = putative_primary_strain), lty = 3)+
  #geom_segment(aes(x = x_dodge, xend = x_dodge, y = logtiter, yend = expected_logtiter_ferret_distance), color = 'firebrick2', lty = 2) +
  #geom_segment(aes(x = x_dodge, xend = x_dodge, y = homologous_titer, yend = logtiter, lty = logtiter<0), show.legend = F) +
  geom_point(aes(x = x_dodge, y = logtiter)) +
  geom_point(aes(x = x_dodge, y = is_undetectable), pch = 23, fill = 'gray') +
  geom_segment(aes(x = x_dodge-.2, xend = x_dodge+.2, y = expected_logtiter_ferret_distance, yend = expected_logtiter_ferret_distance), color = 'firebrick2') +
 # geom_segment(aes(x = x_dodge-.2, xend = x_dodge+.2, y = expected_logtiter_adjusted_distance, yend = expected_logtiter_adjusted_distance), color = 'deepskyblue') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(.~subject_label) +
  ylab('distance from primary strain') +
  ggtitle('High responders')
ggsave('../plots/high_responder_comparison_build1.png', width = 9, height = 6, dpi = 300, units = 'in')
```



```{r}
merged_distances %>%
  filter(is_high_responder) %>%
  mutate(logtiter = ifelse(logtiter<0, NA, logtiter),
         homologous_titer = ifelse(logtiter<0, NA, homologous_titer),
         ferret_map_distance = ifelse(logtiter<0, NA, ferret_map_distance)) %>%
  mutate(ribbon_vals = ifelse(circulated_in_infection_window, as.numeric(strain), NA),
         adjusted_ferret_distance = adjust_ferret_distances(ferret_map_distance, `past/future`),
         expected_logtiter_ferret_distance = homologous_titer - ferret_map_distance,
         expected_logtiter_adjusted_distance = homologous_titer - adjusted_ferret_distance,
         is_undetectable = ifelse(logtiter<0, logtiter, NA)) %>%
  ggplot() +
  geom_point(aes(x = strain, y = logtiter), color = NA) +
  geom_ribbon(aes(x = x_dodge, ymin = -10, ymax = 0), fill = 'gray', alpha = .5) +
  geom_ribbon(aes(x = ribbon_vals, ymin = -10, ymax = 8), fill = 'aquamarine', alpha = .5) +
  geom_hline(aes(yintercept = 0), lty = 3)+
  geom_hline(aes(yintercept = homologous_titer), lty = 2)+
  geom_vline(aes(xintercept = putative_primary_strain), lty = 2, color = 'springgreen3')+
    geom_segment(aes(x = x_dodge, xend = x_dodge, y = logtiter, yend = expected_logtiter_ferret_distance), color = 'firebrick2', lty = 2) +
  geom_segment(aes(x = x_dodge, xend = x_dodge, y = homologous_titer, yend = logtiter, lty = logtiter<0), show.legend = F) +
  geom_point(aes(x = x_dodge, y = logtiter)) +
  geom_segment(aes(x = x_dodge-.2, xend = x_dodge+.2, y = expected_logtiter_ferret_distance, yend = expected_logtiter_ferret_distance),  color = 'firebrick2') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(.~subject_label) +
  ylab('distance from primary strain') +
  ggtitle('High responders') 
ggsave('../plots/high_responder_comparison_detectable_only.png', width = 9, height = 6, dpi = 300, units = 'in')
```


```{r}
merged_distances %>%
  filter(!is_high_responder) %>%
  mutate(logtiter = ifelse(logtiter<0, NA, logtiter),
         homologous_titer = ifelse(logtiter<0, NA, homologous_titer),
         ferret_map_distance = ifelse(logtiter<0, NA, ferret_map_distance)) %>%
  mutate(ribbon_vals = ifelse(circulated_in_infection_window, as.numeric(strain), NA),
         adjusted_ferret_distance = adjust_ferret_distances(ferret_map_distance, `past/future`),
         expected_logtiter_ferret_distance = homologous_titer - ferret_map_distance,
         expected_logtiter_adjusted_distance = homologous_titer - adjusted_ferret_distance,
         is_undetectable = ifelse(logtiter<0, logtiter, NA)) %>%
  ggplot() +
  geom_point(aes(x = strain, y = logtiter), color = NA) +
  geom_ribbon(aes(x = x_dodge, ymin = -15, ymax = 0), fill = 'gray', alpha = .5) +
  geom_ribbon(aes(x = ribbon_vals, ymin = -15, ymax = 6), fill = 'aquamarine', alpha = .5) +
  geom_hline(aes(yintercept = 0), lty = 3)+
  geom_hline(aes(yintercept = homologous_titer), lty = 2)+
  geom_vline(aes(xintercept = putative_primary_strain), lty = 2, color = 'springgreen3')+
    geom_segment(aes(x = x_dodge, xend = x_dodge, y = logtiter, yend = expected_logtiter_ferret_distance), color = 'firebrick2', lty = 2) +
  geom_segment(aes(x = x_dodge, xend = x_dodge, y = homologous_titer, yend = logtiter)) +
  geom_point(aes(x = x_dodge, y = logtiter)) +
  geom_segment(aes(x = x_dodge-.2, xend = x_dodge+.2, y = expected_logtiter_ferret_distance, yend = expected_logtiter_ferret_distance),  color = 'firebrick2') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(.~subject_label) +
  ylab('distance from primary strain') +
  ggtitle('Low responders') 
ggsave('../plots/low_responder_comparison_detectable_only.png', width = 9, height = 6, dpi = 300, units = 'in')
```



```{r}
merged_distances %>%
  filter(!is_high_responder) %>%
  mutate(ribbon_vals = ifelse(circulated_in_infection_window, as.numeric(strain), NA),
         adjusted_ferret_distance = adjust_ferret_distances(ferret_map_distance, `past/future`),
         expected_logtiter_ferret_distance = homologous_titer - ferret_map_distance,
         expected_logtiter_adjusted_distance = homologous_titer - adjusted_ferret_distance,
         is_undetectable = ifelse(logtiter<0, logtiter, NA)) %>%
  ggplot() +
  geom_point(aes(x = strain, y = logtiter), color = NA) +
  geom_ribbon(aes(x = x_dodge, ymin = -15, ymax = 0), fill = 'gray', alpha = .5) +
  geom_ribbon(aes(x = ribbon_vals, ymin = -15, ymax = 6), fill = 'aquamarine', alpha = .5) +
  geom_hline(aes(yintercept = 0), lty = 3)+
  geom_hline(aes(yintercept = homologous_titer), lty = 2)+
  geom_vline(aes(xintercept = putative_primary_strain), lty = 3)+
    geom_segment(aes(x = x_dodge, xend = x_dodge, y = logtiter, yend = expected_logtiter_ferret_distance), color = 'firebrick2', lty = 2) +
  geom_segment(aes(x = x_dodge, xend = x_dodge, y = homologous_titer, yend = logtiter, lty = logtiter<0), show.legend = F) +
  geom_point(aes(x = x_dodge, y = logtiter)) +
    geom_point(aes(x = x_dodge, y = is_undetectable), pch = 23, fill = 'gray') +
  geom_segment(aes(x = x_dodge-.2, xend = x_dodge+.2, y = expected_logtiter_ferret_distance, yend = expected_logtiter_ferret_distance), color = 'firebrick2') +
 # geom_segment(aes(x = x_dodge-.2, xend = x_dodge+.2, y = expected_logtiter_adjusted_distance, yend = expected_logtiter_adjusted_distance), color = 'deepskyblue') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(.~subject_label) +
  ylab('distance from primary strain') +
  ggtitle('Low responders') +
  scale_linetype_manual(values = c(1, 2))
ggsave('../plots/low_responder_comparison.png', width = 9, height = 6, dpi = 300, units = 'in')
```

## Plot child, ferret AUC



```{r}
titer_summary = bind_rows(
  ## Get summary stats for child titers
child_titers %>%
  group_by(subject) %>%
  mutate(max_logtiter = max(logtiter), ## Max titer
            n_detectable = sum(logtiter>=0),
         steepness = max_logtiter/(n_detectable/2)) %>% ## n_detectable
  ungroup() %>% group_by(subject, strain_year, max_logtiter, n_detectable, steepness) %>% ## yearly mean logtiter
  summarise(mean_logtiter = mean(logtiter),
            se_logtiter = sd(logtiter)/sqrt(n()),
            n_strains = n()) %>%
  ungroup() %>%
  rename(id = subject) %>%
  mutate(kind = 'child') %>%
  merge(get_AUC(child_titers$strain_year, child_titers$logtiter, child_titers$subject)), ## AUC
## Get the same summary stats for ferret titers
ferret_titers %>%
  group_by(serum) %>%
  mutate(max_logtiter = max(logtiter), ## Max titer
            n_detectable = sum(logtiter>=0),
         steepness = max_logtiter/(n_detectable/2)) %>% ## n_detectable
  ungroup() %>% group_by(serum, strain_year, max_logtiter, n_detectable, steepness) %>% ## yearly mean logtiter
  summarise(mean_logtiter = mean(logtiter),
            se_logtiter = sd(logtiter)/sqrt(n()),
            n_strains = n()) %>%
  ungroup() %>%
  rename(id = serum) %>%
  mutate(kind = 'ferret')%>%
  merge(get_AUC(ferret_titers$strain_year, ferret_titers$logtiter, ferret_titers$serum)) ## AUC
)
```

## Plot child and ferret titer profiles
```{r}
cowplot::plot_grid(
child_titers %>%
  merge(read_csv('../processed_data/subject_primary_sample_timing.csv')) %>%
  rename(id = subject) %>%
  ggplot() +
  geom_point(aes(x = strain, y = logtiter,  color = logtiter<0))+
  geom_ribbon(aes(x = as.numeric(strain), ymin = 0, ymax = ifelse(logtiter<0, 0, logtiter)), fill = 'salmon', alpha = .5) +
#  geom_text(aes(x = 6, y = 8, label = sprintf('<=%s', max_lag)), size = 3)+
  ggtitle('children') + theme(legend.position = 'none') +
  ylim(c(-1, 12)) +
  geom_hline(aes(yintercept = 0), lty = 3)+
  scale_shape_manual (values = c(16, 1))+
  facet_wrap(.~id, nrow = 5)+
  scale_color_manual(values = c('salmon', 'gray'))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 5)),

ferret_titers %>%
  rename(id = serum) %>%
  ggplot() +
  geom_point(aes(x = strain, y = logtiter, color = logtiter<0))+
  geom_ribbon(aes(x = as.numeric(strain), ymin = 0, ymax = ifelse(logtiter<0, 0, logtiter)), fill = 'mediumturquoise', alpha = .5) +
  ggtitle('ferrets') + theme(legend.position = 'none')+
  ylim(c(-1, 12))+
  geom_hline(aes(yintercept = 0), lty = 3)+
  scale_color_manual(values = c('mediumturquoise', 'gray'))+
  facet_wrap(.~id)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 5)),
  rel_widths = c(1, 1.2)
)
ggsave('../plots/ferret_child_landscapes.png', width = 11, height = 5.5, units = 'in', dpi = 250)
```


```{r}
titer_summary  %>% select(id, kind, max_logtiter, n_detectable, steepness) %>%
  distinct() %>%
  pivot_longer(3:5, names_to = 'statistic', values_to = 'value') %>%
  ggplot() +
  geom_density(aes(x = value, fill = kind), alpha = .5) +
 # geom_point(aes(x = jitter(as.numeric(as.factor(kind))), y = value, color = id), show.legend = F)+
  facet_grid(.~statistic, scales = 'free_x')
ggsave('../plots/ferret_child_titer_summary.png', width = 7.5, height = 3.5, units = 'in', dpi = 200)
```
## Look at distances by ferret distance
## Look at distances by year

```{r}
parse_lag <- function(lag){
  ifelse(lag <= 30, '<=30d',
         ifelse(lag <= 90, '<=90d', '>90d'))
}

ferret_byyear = ferret_distances %>%
  mutate(homologous_strain_year = extract_strain_year(strain1),
         strain_year = extract_strain_year(strain2),
         dy = (strain_year - homologous_strain_year)) %>%
  rename(homologous_strain = strain1,
         strain = strain2) %>%
  mutate(id = (as.factor(homologous_strain)), 
         kind = 'ferret',
         lag = parse_lag(30)) %>%
  select(kind, id, homologous_strain, strain, homologous_strain_year, strain_year, dy, distance, lag)

child_byyear = merged_distances %>%
  filter(logtiter >= 0) %>% #exclude undetectable titers
  mutate(primary_strain_year = extract_strain_year(putative_primary_strain),
         dy =  strain_year-primary_strain_year) %>%
  rename(id = subject,
         distance = individual_distance,
         ferret_distance = ferret_map_distance,
         homologous_strain = putative_primary_strain,
         homologous_strain_year = primary_strain_year) %>%
  mutate(kind = 'child',
         lag = parse_lag(max_lag),
         lag = ifelse(lag == '>90d', 'unknown', lag)) %>%
  select(kind, id, homologous_strain, strain, homologous_strain_year, strain_year, dy, distance, ferret_distance, lag) %>%
  ungroup()

## Add adult distances
vaccine_1995 = read_csv('../../Ha_Nam/processed_data/vaccinations_1995.csv') %>%
  mutate(kind = 'vaccine study') %>%
  filter(logtiter >=0) %>%
  rename(id = subject,
         strain = test_strain,
         strain_year = test_strain_year,
         distance = individual_distance) %>%
  mutate(homologous_strain_year = extract_strain_year(homologous_strain),
         dy = strain_year-homologous_strain_year,
         id = as.character(id),
         lag = parse_lag(30)) %>%
  select(kind, id, homologous_strain, strain, homologous_strain_year, strain_year, dy, distance, ferret_distance, lag)

vaccine_1997 = read_csv('../../Ha_Nam/processed_data/vaccinations_1997.csv')%>%
  mutate(kind = 'vaccine study') %>%
  filter(logtiter >=0) %>%
  rename(id = subject,
         strain = test_strain,
         strain_year = test_strain_year,
         distance = individual_distance) %>%
  mutate(homologous_strain_year = extract_strain_year(homologous_strain),
         dy = strain_year-homologous_strain_year,
         id = as.character(id),
         lag = parse_lag(30)) %>%
  select(kind, id, homologous_strain, strain, homologous_strain_year, strain_year, dy, distance, ferret_distance, lag)

PCR_infections = read_csv('../../Ha_Nam/processed_data/PCR_infections.csv') %>%
  filter(logtiter >=0) %>%
  rename(id = `Subject number`,
         strain = test_strain,
         strain_year = test_strain_year,
         distance = individual_distance) %>%
  mutate(kind = 'HaNam PCR infection', 
         homologous_strain_year = extract_strain_year(homologous_strain),
         dy = strain_year-homologous_strain_year,
         id = as.character(id),
         lag = parse_lag(days_PCR_swab_to_serum_draw)) %>%
  select(kind, id, homologous_strain, strain, homologous_strain_year, strain_year, dy, distance, ferret_distance, lag)

## Bind with the child and ferret distances
merged_byyear = bind_rows(ferret_byyear,
                          child_byyear, 
                          vaccine_1995,
                          vaccine_1997,
                          PCR_infections) %>%
  mutate(kind = sprintf('%s distances: %s strains', kind, ifelse(dy<0, 'past', 'future'))) 
```

## Fit regressions by ferret distance for children


```{r}
one_lm <- function(formula, df){
  this_fit = lm(formula = as.formula(formula), data = df)

  list(fit = this_fit,
       summary = tibble(formula = formula,
         rsquared = summary(this_fit)$r.squared,
         AIC = AIC(this_fit))
  )
}
```

```{r}
child_lm_data = merged_distances %>%
  filter(logtiter >= 0) %>%
  mutate(primary_strain_year = extract_strain_year(putative_primary_strain), 
         dy = strain_year - primary_strain_year,
         `past/future` = ifelse(dy<0, 'past', 'future')) %>%
  select(subject, strain, putative_primary_strain, ferret_map_distance, age_mos, season, n_seasons, `past/future`, individual_distance) %>%
  mutate(`<=1_season` = as.factor(n_seasons<=1),
         ferret_overestimate = ferret_map_distance - individual_distance)
```

```{r}
formula_vec = c('individual_distance ~ ferret_map_distance', 
                'individual_distance ~ ferret_map_distance + `<=1_season`',
                'individual_distance ~ ferret_map_distance + `<=1_season`*`past/future`',
                'individual_distance ~ ferret_map_distance*`past/future`',
                'individual_distance ~ ferret_map_distance*`past/future` + `<=1_season`',
                 'individual_distance ~ ferret_map_distance + `<=1_season` + `past/future`' ) 

## Run all fits
child_fit_list = lapply(formula_vec, one_lm, df = child_lm_data) 
```

## Del AIC
```{r}
child_fit_table = lapply(child_fit_list, function(ll) ll$summary)%>%
  bind_rows() %>%
  arrange(AIC) %>%
  mutate(del_AIC = AIC-min(AIC))
child_fit_table
```
## F test 
```{r}
anova(child_fit_list[[1]]$fit,
      child_fit_list[[2]]$fit,
      child_fit_list[[3]]$fit,
      child_fit_list[[4]]$fit)
```

## Summary of best fit
```{r}
lm(formula = as.formula(as.matrix(child_fit_table[1,1])), data = child_lm_data) %>%
  summary()
```



```{r}
run_lm_by_ferret_distance <- function(ferret_distance, distance, kind){
  this_fit = lm(distance ~ ferret_distance)
 # print(summary(this_fit))
  tibble(kind = unique(kind),
         slope = this_fit$coefficients[2],
         intercept = this_fit$coefficients[1],
         rsquared = summary(this_fit)$r.squared,
         slope_pval = summary(this_fit)$coefficients[2,4],
         slope_pval_star = ifelse(slope_pval<0.05, '*', ''),
         equation = sprintf('y=%2.2f+%2.2fx', intercept, slope))
}

lm_fits_table_by_ferretdistance = lapply(unique(merged_byyear$kind)[-c(1,2)], function(kk){
  this_df = filter(merged_byyear, kind == kk) 
       run_lm_by_ferret_distance(ferret_distance = this_df$ferret_distance, distance = this_df$distance, kind = this_df$kind)
}) %>%
  bind_rows()

lm_fits_table_by_ferretdistance
```


```{r}
run_lm_byyear <- function(dy, distance, kind){
  this_fit = lm(distance ~ dy)
 # print(summary(this_fit))
  tibble(kind = unique(kind),
         slope = this_fit$coefficients[2],
         intercept = this_fit$coefficients[1],
         rsquared = summary(this_fit)$r.squared,
         slope_pval = summary(this_fit)$coefficients[2,4],
         slope_pval_star = ifelse(slope_pval<0.05, '*', ''),
         equation = sprintf('y=%2.2f+%2.2fx', intercept, slope))
}

lm_fits_table_by_year = lapply(unique(merged_byyear$kind), function(kk){
  this_df = filter(merged_byyear, kind == kk)
       run_lm_byyear(dy = this_df$dy, distance = this_df$distance, kind = this_df$kind)
}) %>%
  bind_rows()

lm_fits_table_by_year
```

## For children and ferrets, the past and future slopes are the same within a distance type, but lower in children than ferrets

```{r}
merged_byyear %>%
  filter(grepl('child', kind) | grepl('ferret', kind)) %>%
  ggplot() +
  geom_point(aes(x = dy, y = distance, color = kind), alpha = .7)+
  geom_smooth(aes(x = dy, y = distance, color = kind), method = 'lm', se = F) +
  scale_color_manual(values = c('salmon', 'mediumturquoise', 'firebrick4', 'dodgerblue3')) +
  xlab('years between strains')
ggsave('../plots/distances_by_year_child_ferret.png', width = 6, height = 4.5, dpi = 250, units = 
         'in')
```




## For children and ferrets, the past and future slopes are the same within a distance type, but lower in children than ferrets

```{r}
comparison_plot = merged_byyear %>%
  separate(kind, into = c( 'distance type', 'past/future'), sep = ":", remove = F) %>%
  mutate(`past/future` = factor(`past/future`, levels = c(' past strains',' future strains')),
         `distance type` = factor(`distance type`, levels = c('ferret distances','child distances', 'vaccine study distances', 'HaNam PCR infection distances'), ordered = TRUE),
         lab_x = ifelse(`past/future` == ' past strains', -10, 0),
         lab_y = 15) %>%
  merge(lm_fits_table_by_year) %>%
  ggplot() +
  geom_point(aes(x = jitter(dy), y = jitter(distance), color = lag), alpha = .7)+
  geom_smooth(aes(x = dy, y = distance, group = kind), method = 'lm', color = 'black') +
  geom_text(aes(x = lab_x, y = lab_y, label = sprintf('%2.2f%s\nR2=%2.2f', slope, slope_pval_star, rsquared)),hjust = 0)+
  geom_hline(aes(yintercept=0),lty=3)+
 # scale_color_manual(values = c('salmon', 'mediumturquoise', 'goldenrod', 'yellow3', 'red', 'slateblue4',  'red', 'dodgerblue')) +
  xlab('years from homologous strain to test strain') +
  facet_grid(`distance type`~`past/future`, scales = 'free_x')+
  #theme(legend.position = 'none')+
  ylab('distance')+
  scale_color_manual(values = c('chartreuse4', 'cornflowerblue', 'orange', 'gray'))
ggsave(plot = comparison_plot, '../plots/distances_by_year_child_ferret_adult.png', width = 9, height = 9, dpi = 250, units = 
         'in')
```

```{r}
x_lims = tibble(`past/future` = c(' past strains', ' future strains'),
                xmin = c(-max(abs(merged_byyear$ferret_distance), na.rm = T), 0),
                xmax = c(0, max(abs(merged_byyear$ferret_distance), na.rm = T))) %>%
  mutate(`past/future` = factor(`past/future`, levels = c(' past strains',' future strains'))) %>%
  pivot_longer(-1)

comparison_plot_distance= merged_byyear %>%
  filter(!grepl('ferret', kind)) %>%
  separate(kind, into = c( 'distance type', 'past/future'), sep = ":", remove = F) %>%
  mutate(`past/future` = factor(`past/future`, levels = c(' past strains',' future strains')),
         `distance type` = factor(`distance type`, levels = c('ferret distances','child distances', 'vaccine study distances', 'HaNam PCR infection distances'), ordered = TRUE),
         lab_x = ifelse(`past/future` == ' past strains', -20, 10),
         lab_y = 8,
         ferret_distance = ifelse(`past/future` == ' past strains', -ferret_distance, ferret_distance)) %>%
  merge(lm_fits_table_by_ferretdistance) %>%
  ggplot() +
  geom_point(aes(x = jitter(ferret_distance), y = jitter(distance), color = lag), alpha = .7)+
  geom_smooth(aes(x = ferret_distance, y = distance, group = kind), method = 'lm', color = 'black') +
  geom_text(aes(x = lab_x, y = lab_y, label = sprintf('%2.2f%s\nR2=%2.2f', slope, slope_pval_star, rsquared)), hjust = 0)+
  geom_hline(aes(yintercept=0),lty=3)+
  geom_blank(aes(x =value, y = 1), data = x_lims)+
  geom_abline(aes(intercept = 0, slope = ifelse(`past/future`==' past strains', -1, 1)), lty = 2) +
 # scale_color_manual(values = c('salmon', 'mediumturquoise', 'goldenrod', 'yellow3', 'red', 'slateblue4',  'red', 'dodgerblue')) +
  xlab('ferret distance from homologous strain to test strain') +
  facet_grid(`distance type`~`past/future`, scales = 'free_x')+
  ylab('distance')+
  scale_color_manual(values = c('chartreuse4', 'cornflowerblue', 'orange', 'gray'))+
  ylim(c(-8, 10))
ggsave(plot = comparison_plot_distance, '../plots/distances_by_distance_child_ferret_adult.png', width = 9, height = 9, dpi = 250, units = 
         'in')
```


## Re-plot using violins



```{r}
x_lims = tibble(`past/future` = c(' past strains', ' future strains'),
                xmin = c(-max(abs(merged_byyear$ferret_distance), na.rm = T), 0),
                xmax = c(0, max(abs(merged_byyear$ferret_distance), na.rm = T))) %>%
  mutate(`past/future` = factor(`past/future`, levels = c(' past strains',' future strains'))) %>%
  pivot_longer(-1)
x_lims$value = x_lims$value + c(36, 36, 0, 0) 

comparison_plot_distance = merged_byyear %>%
  filter(!grepl('ferret', kind)) %>%
  separate(kind, into = c( 'distance type', 'past/future'), sep = ":", remove = F) %>%
  mutate(`past/future` = factor(`past/future`, levels = c(' past strains',' future strains')),
         `distance type` = factor(`distance type`, levels = c('ferret distances','child distances', 'vaccine study distances', 'HaNam PCR infection distances'), ordered = TRUE),
         lab_x = ifelse(`past/future` == ' past strains', -20, 10),
         lab_y = 8,
         ferret_distance = ifelse(`past/future` == ' past strains', -ferret_distance, ferret_distance)) %>%
  merge(lm_fits_table_by_ferretdistance) %>%
    mutate(ferret_distance_binned = factor(floor(ferret_distance)),
           nbin = as.numeric(ferret_distance_binned)) %>%
  ggplot() +
  geom_violin(aes(x = ferret_distance_binned, y = distance), alpha = .7)+
  #geom_smooth(aes(x = ferret_distance, y = distance, group = kind), method = 'lm', color = 'black') +
  #geom_text(aes(x = lab_x, y = lab_y, label = sprintf('%2.2f%s\nR2=%2.2f', slope, slope_pval_star, rsquared)), hjust = 0)+
  geom_hline(aes(yintercept=0),lty=3)+
#  geom_blank(aes(x =value+36, y = 1), data = x_lims)+
  geom_abline(aes(intercept = ifelse(`past/future`==' past strains', 36, 0), slope = ifelse(`past/future`==' past strains', -1, 1)), lty = 2) +
 # scale_color_manual(values = c('salmon', 'mediumturquoise', 'goldenrod', 'yellow3', 'red', 'slateblue4',  'red', 'dodgerblue')) +
  xlab('ferret distance from homologous strain to test strain') +
  facet_grid(`distance type`~`past/future`, scales = 'free_x')+
  ylab('distance')+
  scale_color_manual(values = c('chartreuse4', 'cornflowerblue', 'orange', 'gray'))+
  ylim(c(-8, 10))
comparison_plot_distance
ggsave(plot = comparison_plot_distance, '../plots/distance_violins.png', width = 9, height = 9, dpi = 250, units = 'in')
```


```{r}
comparison_plot_distance = merged_byyear %>%
  filter(!grepl('ferret', kind)) %>%
  separate(kind, into = c( 'distance type', 'past/future'), sep = ":", remove = F) %>%
  mutate(`past/future` = factor(`past/future`, levels = c(' past strains',' future strains')),
         `distance type` = factor(`distance type`, levels = c('ferret distances','child distances', 'vaccine study distances', 'HaNam PCR infection distances'), ordered = TRUE),
         lab_x = ifelse(`past/future` == ' past strains', -20, 10)) %>%
  merge(lm_fits_table_by_ferretdistance) %>%
  rename(individual_distance = distance) %>%
  pivot_longer(cols = c(individual_distance, ferret_distance), values_to = 'distance', names_to = 'dist_type', names_pattern = '(\\w+)_distance') %>%
  ggplot() +
  geom_violin(aes(x = as.factor(dy), y = distance, color = dist_type), alpha = .7)+
  #geom_smooth(aes(x = ferret_distance, y = distance, group = kind), method = 'lm', color = 'black') +
  #geom_text(aes(x = lab_x, y = lab_y, label = sprintf('%2.2f%s\nR2=%2.2f', slope, slope_pval_star, rsquared)), hjust = 0)+
 # geom_hline(aes(yintercept=0),lty=3)+
#  geom_blank(aes(x =value+36, y = 1), data = x_lims)+
  #geom_abline(aes(intercept = ifelse(`past/future`==' past strains', 36, 0), slope = ifelse(`past/future`==' past strains', -1, 1)), lty = 2) +
 # scale_color_manual(values = c('salmon', 'mediumturquoise', 'goldenrod', 'yellow3', 'red', 'slateblue4',  'red', 'dodgerblue')) +
  xlab('temporal distance to homologous strain (years)') +
  facet_grid(`distance type`~`past/future`, scales = 'free_x')+
  ylab('distance')+
  scale_color_manual(values = c('chartreuse4', 'cornflowerblue', 'orange', 'gray'))+
  ylim(c(-8, 10))
comparison_plot_distance
ggsave(plot = comparison_plot_distance, '../plots/dy_violins.png', width = 9, height = 9, dpi = 250, units = 'in')
```


```{r}
max_val = max(abs(merged_byyear %>% dplyr::filter(grepl('child', kind)) %>% pull(ferret_distance)), na.rm = T)
x_lims = tibble(`past/future` = c(' past strains', ' future strains'),
                xmin = c(-max_val, 0),
                xmax = c(0, max_val)) %>%
  mutate(`past/future` = factor(`past/future`, levels = c(' past strains',' future strains'))) %>%
  pivot_longer(-1)

comparison_plot_distance= merged_byyear %>%
  filter(grepl('child', kind)) %>%
  separate(kind, into = c( 'distance type', 'past/future'), sep = ":", remove = F) %>%
  mutate(`past/future` = factor(`past/future`, levels = c(' past strains',' future strains')),
         `distance type` = factor(`distance type`, levels = c('ferret distances','child distances', 'vaccine study distances', 'HaNam PCR infection distances'), ordered = TRUE),
         lab_x = ifelse(`past/future` == ' past strains', -20, 10),
         lab_y = 5,
         ferret_distance = ifelse(`past/future` == ' past strains', -ferret_distance, ferret_distance)) %>%
  merge(lm_fits_table_by_ferretdistance) %>%
  ggplot() +
  geom_point(aes(x = ferret_distance_binned, y = jitter(distance), color = lag), alpha = .7)+
  geom_smooth(aes(x = ferret_distance, y = distance, group = kind), method = 'lm', color = 'black') +
  geom_text(aes(x = lab_x, y = lab_y, label = sprintf('%2.2f%s\nR2=%2.2f', slope, slope_pval_star, rsquared)), hjust = 0)+
  geom_hline(aes(yintercept=0),lty=3)+
  geom_blank(aes(x =value, y = 1), data = x_lims)+
  geom_abline(aes(intercept = 0, slope = ifelse(`past/future`==' past strains', -1, 1)), lty = 2) +
  xlab('ferret distance from homologous strain to test strain') +
  facet_grid(`distance type`~`past/future`, scales = 'free_x')+
  ylab('distance')+
  scale_color_manual(values = c('cornflowerblue', 'gray'))+
  ylim(c(-8, 10))
ggsave(plot = comparison_plot_distance, '../plots/distances_by_distance_child.png', width = 9, height = 4, dpi = 250, units = 
         'in')
```






## Can we use a linear model to represent these residuals?

```{r}
ferret_distance_fit = lm(ferret_overestimate~ferret_map_distance, data = child_lm_data)
summary(ferret_distance_fit)
AIC(ferret_distance_fit)
```

```{r}
ferret_distance_fit_by_timing = lm(ferret_overestimate~ferret_map_distance*`past/future`, data = child_lm_data)
summary(ferret_distance_fit_by_timing)
AIC(ferret_distance_fit_by_timing)
```

```{r}
ferret_distance_fit_by_lag = lm(ferret_overestimate~ferret_map_distance*`<=1_season`, data = child_lm_data)
summary(ferret_distance_fit_by_lag)
AIC(ferret_distance_fit_by_lag)
```

```{r}
ferret_distance_fit_by_lag_timing = lm(ferret_overestimate~ferret_map_distance*`<=1_season`*`past/future`, data = child_lm_data)
summary(ferret_distance_fit_by_lag_timing)
AIC(ferret_distance_fit_by_lag_timing)
```


```{r}
temporal_distance_fit = lm(ferret_overestimate~temporal_distance, data = merged_distances %>% filter(logtiter>=0))
summary(temporal_distance_fit)
AIC(temporal_distance_fit)
```

```{r}
temporal_distance_fit_grouped = lm(ferret_overestimate~temporal_distance*is_high_responder, data = merged_distances %>% filter(logtiter>=0))
summary(temporal_distance_fit)
AIC(temporal_distance_fit)
```

## Both the grouped models are significantly better fit to data

```{r}
anova(ferret_distance_fit_by_lag, ferret_distance_fit_by_timing, ferret_distance_fit)
anova(temporal_distance_fit_grouped, temporal_distance_fit)
```

## Compare models

The ferret_distance model with separate slopes for high and low responders is the best AIC

But the high/low responder grouping is not generalizable, so we'll just take the overall fit 

```{r}
tibble(model = c('temporal_distance', 'temporal_distance_grouped', 'ferret_distance', 'ferret_distance_lag', 'ferret_distance_timing', 'ferret_distance_lag_timing'),
       AIC = c(AIC(temporal_distance_fit), AIC(temporal_distance_fit_grouped), AIC(ferret_distance_fit), AIC(ferret_distance_fit_by_lag), AIC(ferret_distance_fit_by_timing), AIC(ferret_distance_fit_by_lag_timing))) %>%
  mutate(del_AIC = AIC-min(AIC)) %>%
  arrange(del_AIC)
```
## Save the best fit
```{r}
write_rds(x = ferret_distance_fit_by_timing, '../processed_data/primary_ferret_human_distance_lm.rds')
```


## The ferret distance model is better -- it has a lower AIC

```{r}
merged_distances %>%
  filter(logtiter>=0) %>%
  ggplot(aes(x = ferret_map_distance, y = ferret_overestimate)) +
  geom_point(alpha = .5) 
ggsave('../plots/regression_fit_0.png')
```


```{r}
merged_distances %>%
  ggplot(aes(x = ferret_map_distance, y = ferret_overestimate)) +
  geom_point(alpha = .5) +
  geom_smooth(method = lm, formula = 'y~x', se = TRUE)
ggsave('../plots/regression_fit.png')
```

```{r}
merged_distances %>%
  filter(logtiter>=0) %>%
  ggplot(aes(x = temporal_distance, y = ferret_overestimate)) +
  geom_point(alpha = .5) +
  geom_smooth(method = lm, formula = 'y~x', se = TRUE)
```





