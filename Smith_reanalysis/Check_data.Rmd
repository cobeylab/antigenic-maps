---
title: "Check data"
output: html_notebook
---

Smith et al., 2004 did not publish supplementary data. 

However, the supplement of Bedford et al. 2014 contains data from Smith et al. 2014. 

This notebook imports the data from the Bedford et al. supplement, and checks that it contains the observations used by Bedford et al. 2014 or Smith et al. 2004 to infer maps.


```{r}
library(tidyverse)
```



## Import the data

```{r}
download.file("https://raw.githubusercontent.com/cobeylab/data-emporium/main/Influenza-titer-panel-data/ferrets/Bedford_et_al_2014/H3N2_HI_data.txt", 
    destfile = "Bedford_2014_data.txt", method = "curl")
Bedford_data <- read_delim("Bedford_2014_data.txt")
```


## Bedford et al. expected data

The methods of Bedford et al. 2014 state:

> We compiled an antigenic dataset of hemagglutination inhibition (HI) measurements of virus isolates against post-infection ferret sera **for influenza A/H3N2** by collecting data from previous publications (Hay and Gregory, 2001; Smith et al., 2004; Russell et al., 2008; Barr et al., 2010), NIMR vaccine strain selection reports for 2002 and 2008â€“2012 (Hay et al., 2002; 2008a, 2009a; McCauley et al., 2010a; 2010b, 2011b, 2012)  and  the  February  2011  VRBPAC  report  (Cox,  2011). 

>Because we are interested in longer-term antigenic evolution, **we subsampled the data to have at most 20 virus isolates per year, preferentially keeping those isolates with more antigenic comparisons.** We then kept only those serum isolates that are relatively informative to the antigenic placement of viruses, dropping serum isolates that are compared to four or fewer different virus isolates.

> **This censoring left 402 virus isolates, 519 serum** [for H3N2].


## 1. Check that these data contain 402 virus isolates of H3N2

```{r}
Bedford_data %>%
  group_by(virusIsolate) %>%
  summarise(n_strains_per_isolate = n()) %>%
  mutate(n_virus_isolates = nrow(.))
```

It looks like there are 427, not 402 isolates in the data. Maybe if we group by virusStrain there will be 402?
```{r}
df <- Bedford_data %>%
  group_by(virusStrain) %>%
  summarise(n_sera_per_strain = n()) %>%
  mutate(n_strains = nrow(.)) 

df %>%
  ggplot() +
  geom_histogram(aes(x=n_sera_per_strain), binwidth = 1) +
  ggtitle(sprintf('%s unique strains', unique(df$n_strains)))
```

[yes] - There are 402 unique virusStrain values in the data frame.

Look at the rows in which a virusStrain contains more than one virusIsolate
```{r}
Bedford_data %>%
  group_by(virusStrain, virusIsolate) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  group_by(virusStrain) %>%
  mutate(n_strain_repeats = n()) %>%
  filter(n_strain_repeats > 1)
```

It looks like the virusStrain column is just a standardized version of the virusIsolate column. Nomenclature is more variable in the virus Isolate column.


## 2. Check that these data contain 519 sera for H3N2

```{r}
df <- Bedford_data %>%
  group_by(serumIsolate) %>%
  summarise(n_strains_per_serum = n()) %>%
  mutate(n_sera = nrow(.)) 

df %>%
  ggplot() +
  geom_histogram(aes(x=n_strains_per_serum), binwidth = 1) +
  ggtitle(sprintf('%s unique sera', unique(df$n_sera)))
```

Confusingly, it looks like we're supposed to use the `serumIsolate` column and the `virusStrain` column, not `serumStrain` and `virusStrain`.

I guess this is because:

* The batch matters for sera.
* The antigenic structure (not the batch) matters for the virus?





---------------------


# Check the Smith data

The methods of Smith et al. 2004 state:

>Antigenic data from 35 years of [H3N2] influenza  surveillance  between  1968  and  2003 were combined into a single dataset. We sequenced the HA1 domain of a subset of thesevirus isolates (26,27) and restricted the an-tigenic analysis to these sequenced isolates tofacilitate a direct comparison of antigenic and genetic evolution. 

> The resulting   antigenic dataset consisted  of  a  table  of **79  post infection ferret antisera by 273 viral isolates**, with **4215 individual HI measurements** as entries in the table. 

> Ninety-four of the isolates werefrom epidemics in the Netherlands, and 179were from elsewhere in the world.

```{r}
Smith_data <- Bedford_data %>%
  filter(source %in% c('Smith2004'))
```


## 1. Check that there are 79 unique antisera

```{r}
df <- Smith_data %>%
  group_by(serumIsolate) %>%
  summarise(n_strains_per_serum = n()) %>%
  mutate(n_sera = nrow(.)) 

df %>%
  ggplot() +
  geom_histogram(aes(x=n_strains_per_serum), binwidth = 1) +
  ggtitle(sprintf('%s unique sera', unique(df$n_sera)))
```
-> We have one less serum than the original Smith 2004 paper


## 2. Check that there are 273 unique viruses
```{r}
df <- Smith_data %>%
  group_by(virusStrain) %>%
  summarise(n_sera_per_strain = n()) %>%
  mutate(n_strains = nrow(.)) 

df %>%
  ggplot() +
  geom_histogram(aes(x=n_sera_per_strain), binwidth = 1) +
  ggtitle(sprintf('%s unique strains', unique(df$n_strains)))
```
--> There are about 60 fewer strains in the panel than in the original Smith 2004 paper


## 3. Check that there are 4215 HI measurements

```{r}
Smith_data
```

## There are only 3541 rows in this dataset, and the number of strains and antisera is lower than expected. 

It looks like about 84% (3541 of 4215) of the observations from Smith 2004 are present here.
The available rows account for almost all sera (78/79), and most strains (216/273)
It's possible that some observations were filtered out because there were fewer than 4 strains per serum.

## Visualize the distribution of strain and titer years
```{r}
Smith_data %>%
  group_by(virusYear, serumYear) %>%
  summarise(n = n()) %>%
  ggplot() +
  geom_point(aes(x = virusYear, y = serumYear, size = n, color = n), alpha = .3) +
  scale_color_viridis_c() +
  scale_size(limits = c(0, 75))
```


